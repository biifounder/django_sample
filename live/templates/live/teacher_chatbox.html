{% extends 'courses/main.html' %}
{% load static %}

{% block content %}
<head>
    <title>حصة تفاعلية</title>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: auto; padding: 20px; }
        #question-counter { font-size: 1.2em; font-weight: bold; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .correct-answer { color: #22c55e; font-weight: bold; }
        .question-image { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; }
        #timer-display { font-size: 2em; font-weight: bold; color: #f97316; margin: 15px 0; }
        
        /* New CSS for the questions table */
        #questions-table th {
            text-align: right;
            padding: 10px;
        }
        #questions-table td {
            text-align: right;
            padding: 8px;
            vertical-align: top;
        }
        .message-column {
            width: 60%;
        }

        /* Added CSS for text direction */
        .message-rtl {
            direction: rtl;
        }
        .message-ltr {
            direction: ltr;
        }

        /* Styling for question statistics */
        .stats-container { margin-top: 20px; }
        .stat-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            background-color: #f0f4f8;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .stat-item.correct {
            border-color: #22c55e;
            background-color: #e7f6d5;
        }
        .option-text { flex: 1; text-align: right; margin-right: 15px; }
        .answer-count { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>حصة تفاعلية في درس: {{lesson.head}}</h1>
        
        <div id="quiz-controls">
            <p>تقدم الاختبار: <span id="question-counter">0</span> / <span id="total-questions"></span></p>

            <button id="next-question-button" style="width:30%;">السؤال الاول</button>
            <button id="pause-resume-button" style="display: none; width:30%">انتظر</button>
        </div>

        <div id="question-stats-section" style="display: none;">
            <h2>إحصائيات السؤال</h2>
            <div id="stats-container" class="stats-container"></div>
        </div>
        
        <h1>الدرجات</h1>
        <table id="score-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>المركز</th>
                    <th>اسم الطالب</th>
                    <th>الدرجة</th>
                    <th>أسئلة لم يجيب عليها</th>
                    <th>عدد الرسائل</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        
        <button id="export-scores-button" data-lesson-name="{{ lesson.head }}" style="background-color: rgb(189, 189, 189); width:40%">حفظ الدرجات</button>

        <hr style="margin-top: 30px; margin-bottom: 30px;">
        <h1>أسئلة الطلاب</h1>
        <table id="questions-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 20%;">اسم الطالب</th>
                    <th class="message-column">آخر رسالة</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        let questions = JSON.parse("{{questions|escapejs}}");  

        let quizSocket;
        if (window.location.host === '127.0.0.1:8000') {
            quizSocket = new WebSocket('ws://' + window.location.host + '/ws/quiz/' + '{{ room_name }}' + '/');
        } else {
            const SERVER_URL = '139-162-254-40.ip.linodeusercontent.com';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            quizSocket = new WebSocket(`${wsProtocol}://${SERVER_URL}/ws/quiz/{{ room_name }}/`);
        }
        
        const nextQuestionButton = document.getElementById('next-question-button');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const exportScoresButton = document.getElementById('export-scores-button');
        const questionCounter = document.getElementById('question-counter');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const scoreTableBody = document.querySelector('#score-table tbody');
        const questionsTableBody = document.querySelector('#questions-table tbody');
        const statsSection = document.getElementById('question-stats-section');
        const statsContainer = document.getElementById('stats-container');
        
        let currentQuestionIndex = 0;
        let timerInterval;
        let timeLeft = 0;
        let isTimerRunning = false;
        let studentQuestions = {};
        let messageOrderCounter = 0;

        totalQuestionsSpan.textContent = questions.length;

        quizSocket.onopen = function() {
            console.log('Teacher socket opened');
        };

        // Function to detect Arabic characters
        function isArabic(text) {
            const arabicRegex = /[\u0600-\u06FF]/;
            return arabicRegex.test(text);
        }

        quizSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Received message:", data);

            if (data.type === 'update_score') {
                updateScoreTable(data.content);
            } else if (data.type === 'student_question') {
                const studentName = data.content.name;
                const questionText = data.content.question;

                messageOrderCounter++;
                if (!studentQuestions[studentName]) {
                    studentQuestions[studentName] = {
                        name: studentName,
                        lastMessage: questionText,
                        messageCount: 1,
                        lastOrder: messageOrderCounter
                    };
                } else {
                    studentQuestions[studentName].lastMessage = questionText;
                    studentQuestions[studentName].messageCount++;
                    studentQuestions[studentName].lastOrder = messageOrderCounter;
                }

                updateQuestionsTable();
            } else if (data.type === 'quiz_reset') {
                 // Reset student data when the quiz is reset
                studentQuestions = {};
                messageOrderCounter = 0;
                questionsTableBody.innerHTML = '';
            } else if (data.type === 'question_stats') {
                displayQuestionStats(data.content);
            }
        };

        quizSocket.onclose = function() {
            console.error('Teacher socket closed unexpectedly');
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startTimer(timeLimit) {
            isTimerRunning = true;
            timeLeft = timeLimit;
            pauseResumeButton.style.display = 'inline-block';
            pauseResumeButton.textContent = 'انتظر';

            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                }
            }, 1000);
        }

        nextQuestionButton.addEventListener('click', function() {
            clearInterval(timerInterval);
            isTimerRunning = false;

            if (currentQuestionIndex < questions.length) {
                const currentQuestion = questions[currentQuestionIndex];
                const shuffledOptions = shuffleArray([...currentQuestion.options]);
                const questionToSend = {
                    ...currentQuestion,
                    options: shuffledOptions
                };
                
                // Clear previous question stats
                statsSection.style.display = 'none';
                statsContainer.innerHTML = '';

                quizSocket.send(JSON.stringify({
                    'type': 'new_question',
                    'content': questionToSend
                }));
                
                startTimer(currentQuestion.time_limit);
                
                currentQuestionIndex++;
                questionCounter.textContent = currentQuestionIndex;
                nextQuestionButton.textContent = "السؤال التالي";

            } else {
                nextQuestionButton.disabled = true;
                pauseResumeButton.style.display = 'none';
                quizSocket.send(JSON.stringify({ 'type': 'quiz_end' }));
            }
            MathJax.typeset();
        });
        
        pauseResumeButton.addEventListener('click', function() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                pauseResumeButton.textContent = 'استمر';
                quizSocket.send(JSON.stringify({
                    'type': 'timer_pause',
                    'content': timeLeft
                }));
            } else {
                startTimer(timeLeft);
                isTimerRunning = true;
                pauseResumeButton.textContent = 'انتظر';
                quizSocket.send(JSON.stringify({
                    'type': 'timer_resume'
                }));
            }
        });

        function updateScoreTable(scores) {
            const sortedStudents = Object.values(scores).sort((a, b) => b.score - a.score);
            const totalQuestions = parseInt(totalQuestionsSpan.textContent);
            scoreTableBody.innerHTML = '';
            let rank = 1;
            let lastScore = -1;
            sortedStudents.forEach((student, index) => {
                if (student.score < lastScore) {
                    rank = index + 1;
                }
                const row = document.createElement('tr');
                const answeredQuestions = student.answered || 0;
                const unansweredQuestions = totalQuestions - answeredQuestions;
                const messageCount = student.message_count || 0;
                
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${student.name}</td>
                    <td>${student.score} / ${totalQuestions}</td>
                    <td>${unansweredQuestions}</td>
                    <td>${messageCount}</td>
                `;
                scoreTableBody.appendChild(row);
                lastScore = student.score;
            });
        }
        
        function displayQuestionStats(stats) {
            statsContainer.innerHTML = '';
            statsSection.style.display = 'block';

            // Convert stats object to an array for sorting
            const optionsArray = Object.entries(stats.counts);

            // Sort array to put the correct answer first
            optionsArray.sort(([optionA, countA], [optionB, countB]) => {
                const isCorrectA = optionA.trim() === stats.correct_answer.trim();
                const isCorrectB = optionB.trim() === stats.correct_answer.trim();
                
                if (isCorrectA && !isCorrectB) return -1;
                if (!isCorrectA && isCorrectB) return 1;
                
                // For other options, sort by count descending
                return countB - countA;
            });

            optionsArray.forEach(([option, count]) => {
                const isCorrect = option.trim() === stats.correct_answer.trim();
                const item = document.createElement('div');
                item.className = 'stat-item';
                if (isCorrect) {
                    item.classList.add('correct');
                }
                
                item.innerHTML = `
                    <span class="option-text">${option}</span>
                    <span class="answer-count">${count}</span>
                `;
                statsContainer.appendChild(item);
            });
            MathJax.typeset();
        }

        function updateQuestionsTable() {
            questionsTableBody.innerHTML = '';
            const allStudents = Object.values(studentQuestions);
            allStudents.sort((a, b) => b.lastOrder - a.lastOrder);
            allStudents.forEach(studentData => {
                const row = document.createElement('tr');
                // Apply the correct direction class based on the message content
                if (isArabic(studentData.lastMessage)) {
                    row.classList.add('message-rtl');
                } else {
                    row.classList.add('message-ltr');
                }
                row.innerHTML = `
                    <td>${studentData.name}</td>
                    <td>${studentData.lastMessage}</td>
                `;
                questionsTableBody.appendChild(row);
            });
        }

        exportScoresButton.addEventListener('click', function() {
            exportScoresToCsv();
        });

        function exportScoresToCsv() {
            const tableRows = scoreTableBody.querySelectorAll('tr');
            let csvContent = "Rank,Student,Score,Unanswered,Messages\n";
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent);
                csvContent += rowData.join(',') + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const lessonName = document.getElementById('export-scores-button').getAttribute('data-lesson-name');
            link.setAttribute("download", `${lessonName}_scores.csv`);
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
{% endblock %}