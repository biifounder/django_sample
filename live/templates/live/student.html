{% extends 'courses/main.html' %}
{% load static %}

{% block content %}
<head>
    <title>ÿµŸÅÿ≠ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®</title>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js"></script>
    <script src="https://8x8.vc/external_api.js"></script>
    <style>
        /* General page styling */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* üéØ KEY CHANGE: SWITCH TO SINGLE-COLUMN LAYOUT */
        .main-container {
            display: flex;
            flex-direction: column; /* Stack children vertically */
            height: auto; 
            min-height: 100vh; 
            width: 100%;
        }

        /* TOP SECTION: The Video/Question display area */
        .video-container {
            width: 100%; 
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: flex-start;
            padding: 20px;
            box-sizing: border-box;
            position: relative; 
            height: auto;
            order: 1; 
        }
        
        /* BOTTOM SECTION: Score and Chat (The content container) */
        .content-container {
            width: 100%; /* Changed from 50% to 100% to match full-width container */
            overflow-y: visible; 
            padding: 20px;
            box-sizing: border-box;
            direction: rtl; 
            order: 2; 
            /* Remove align-items: center; here, use margin auto on children instead */
        }

        /* Display Wrapper - Controls Overlap and FLEXIBILITY */
        #display-wrapper {
            position: relative; 
            width: 95%;
            max-width: 800px; 
            min-height: 450px; /* Enforce minimum height for video area */
            height: auto; 
            background-color: black;
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            /* Margin bottom ensures separation from the content below */
            margin-bottom: 20px; 
        }

        /* Jitsi iframe wrapper and Question Panel need to be statically positioned now */
        #jitsi-container-wrapper,
        #question-panel {
            position: relative; 
            top: auto;
            left: auto;
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto; 
            min-height: 450px; /* Ensure space reservation */
        }

        /* Set a fixed height for the video to maintain aspect ratio */
        #jitsi-container-wrapper {
            padding-top: 0; 
        }

        /* Jitsi iframe styling to fit its container */
        #jitsi-iframe {
            position: relative; 
            top: 0;
            left: 0;
            width: 100%;
            height: 450px; /* Keep fixed height for stability */
            display: block;
            border: none;
        }
        
        /* Question Panel Styling */
        #question-panel {
            display: none; 
            background-color: #ffffff;
            padding: 20px;
            text-align: right;
            direction: rtl;
            min-height: 450px; /* Ensure it covers the video space */
        }

        /* Additional style adjustments for mobile view to ensure full width */
        #login-form {
            width: 100%;
            max-width: 400px; 
            margin: 0 auto;
            padding-top: 50px;
        }

        /* New styles for centering the message input/button area */
        .message-input-area {
            width: 100%;
            max-width: 600px; 
            margin-left: auto; /* Center the box */
            margin-right: auto; /* Center the box */
            text-align: center; /* Center the contents (like the button) */
        }

        .message-input-area textarea {
             /* Ensure textarea takes full width within its centered parent */
            width: 100%; 
            height:80px; 
            padding:10px; 
            border-radius:5px;
            box-sizing: border-box; /* Include padding/border in the width calculation */
            text-align: right; /* Keep the input text RTL */
        }
        
        /* Centering the Send button */
        #send-question-button {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            background-color: rgb(209, 209, 209);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: block; /* Make it block to use margin auto */
            margin-left: auto; /* Center the button */
            margin-right: auto; /* Center the button */
        }
        
        /* ... Existing styles for options, score, and messages ... */
        .question-content { min-height: 100px; padding: 0; text-align: right; font-size: 1.5em; font-weight: bold; }
        .options-container { display: flex; flex-direction: column; }
        .option-btn {
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: black;
            font-size: 1.2em;
            width: 100%;
            min-height: 40px;
            padding: 10px 1.2em;
            text-align: right;
            background: transparent;
            border: 1px solid #25252b;
            border-radius: 0.3em;
            margin-top: 10px;
        }
        .option-btn:first-child { margin-top: 10px; }
        .option-btn:hover:not(:disabled) { background-color: #9d9db6; }
        .option-btn:disabled { cursor: not-allowed; }
        .option-btn.correct { background-color: #e7f6d5 !important; border-color: #689f38 !important; }
        .option-btn.incorrect { background-color: #ffdde0 !important; border-color: #d32f2f !important; }
        .message { padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .question-image { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; }
        .question-text { color: #000000; font-size: 1.2em; font-weight: bold;}
        #timer-display { font-size: 2em; font-weight: bold; color: #f97316; margin: 15px 0; text-align: center; }
        #timer-message { margin-top: 10px; color: #0207a3; text-align: center; font-size:20px ; font-family: 'Amiri', serif;}
        .sent-message-item {
            background-color: #f0f4f8;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-right: 4px solid #10b981;
            position: relative;
        }
        .sent-message-item.ltr { direction: ltr; text-align: left; }
        .sent-message-item.rtl {
            direction: rtl;
            text-align: right;
            border-right: none;
            border-left: 4px solid #10b981;
        }
        .sent-message-text {
            color: #4b5563;
            font-size: 1em;
            line-height: 1.5;
            display: block;
            padding-left: 30px; 
            padding-right: 0;
        }
        .sent-message-item.rtl .sent-message-text {
            padding-left: 0;
            padding-right: 30px;
        }
        .edit-icon {
            position: absolute;
            top: 50%;
            left: 10px; 
            transform: translateY(-50%);
            cursor: pointer;
            color: #4a90e2;
            font-size: 1.5em;
        }
        .sent-message-item.rtl .edit-icon {
            left: auto;
            right: 10px;
        }
        .edit-icon:hover {
            color: #0056b3;
        }

    </style>
</head>
<body>
<div class="main-container">
    <div id="login-form">
      <h1>ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ</h1>
      <p>ŸÑŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿ•ŸÑŸâ ÿßŸÑÿØÿ±ÿ≥ÿå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ.</p>
      <input type="text" id="student-name-input" placeholder="ÿßÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ŸáŸÜÿß" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
      <button id="join-button" style="width: 100%; padding: 10px; color: rgb(0, 0, 0); border-radius: 5px; cursor: pointer;">ÿßŸÜÿ∂ŸÖ</button>
    </div>

    <div id="main-content" style="display: none; width: 100%;">
        
        <div style="text-align: center; direction: rtl; padding: 20px 0;">
            <h1 style="font-size:40px">ÿØÿ±ÿ≥: {{lesson.head}}</h1>
            <h1>ŸÖÿ±ÿ≠ÿ®ÿß <span id="student-name-display"></span></h1>
            <h1 class="mt-4">ÿØÿ±ÿ¨ÿ™ŸÉ: <span id="student-score">0</span>   &nbsp;&nbsp;&nbsp;      ÿ£ŸÜÿ™ ŸÅŸä ÿßŸÑŸÖÿ±ŸÉÿ≤: <span id="student-rank">-</span></h1>
        </div>

        <div class="video-container">
            
            <div id="display-wrapper">

                <div id="jitsi-container-wrapper">
                    <div id="jitsi-container" style="height: 100%; width: 100%;"></div>
  
                </div>

                <div id="question-panel">
                    <p id="initial-message">ÿ£ŸÜÿ™ ŸÖÿ™ÿµŸÑ. ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑÿØÿ±ÿ≥.</p>
                    <div class="question-content">
                        </div>
                    
                    <div id="options-container" class="options-container">
                        </div>
                    
                    <div id="timer-display"></div>
                    <div id="timer-message"></div>
                </div>

            </div>

        </div>

        <div class="content-container">           
            
            <div id="teacher-message-display" style="display: none; padding: 15px; border: 1px solid #1e1653; border-radius: 5px; margin-bottom: 20px; direction: rtl; text-align: right;" class="message-input-area">
                <p style="font-weight: bold; color: #030200; margin-bottom: 5px;">ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸÖ:</p>
                <p id="teacher-message-text" style="color: #000000; margin: 0; line-height: 1.5;"></p>
            </div>

            <div class="message-input-area" style="margin-top: 30px;">
                <textarea id="student-question-input" placeholder="ÿ£ÿ±ÿ≥ŸÑ ŸÑŸÑŸÖÿπŸÑŸÖ ŸáŸÜÿß..." ></textarea>
                <button id="send-question-button" >ÿ£ÿ±ÿ≥ŸÑ</button>
            </div>
            
            <div id="messages-container" class="message-input-area" style="margin-top: 20px;"></div>
        </div>
        
    </div>
</div>

<script>
    const storedName = sessionStorage.getItem('studentName');
    let myName = storedName || '';

    const loginForm = document.getElementById('login-form');
    const mainContent = document.getElementById('main-content');
    const studentNameInput = document.getElementById('student-name-input');
    const joinButton = document.getElementById('join-button');
    
    // ELEMENTS FOR OVERLAP CONTROL
    const displayWrapper = document.getElementById('display-wrapper');
    const jitsiWrapper = document.getElementById('jitsi-container-wrapper');
    const questionPanel = document.getElementById('question-panel');
    const initialMessage = document.getElementById('initial-message');
    
    const questionContent = document.querySelector('#question-panel .question-content');
    const optionsContainer = document.getElementById('options-container');
    const studentScoreSpan = document.getElementById('student-score');
    const studentRankSpan = document.getElementById('student-rank');
    const studentNameDisplay = document.getElementById('student-name-display');
    const timerDisplay = document.getElementById('timer-display');
    const timerMessage = document.getElementById('timer-message');

    const studentQuestionInput = document.getElementById('student-question-input');
    const sendQuestionButton = document.getElementById('send-question-button');
    const messagesContainer = document.getElementById('messages-container');

    // Teacher message display elements
    const teacherMessageDisplay = document.getElementById('teacher-message-display');
    const teacherMessageText = document.getElementById('teacher-message-text');
    
    let quizSocket;
    if (window.location.protocol === 'http:' && window.location.host.includes('127.0.0.1')) {
        quizSocket = new WebSocket('ws://' + window.location.host + '/ws/quiz/' + '{{ room_name }}' + '/');
    } else {
        const SERVER_URL = '139-162-254-40.ip.linodeusercontent.com';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        quizSocket = new WebSocket(`${wsProtocol}://${SERVER_URL}/ws/quiz/{{ room_name }}/`);
    }
    
    let timerInterval;
    let timeLeft;
    let currentQuestionData = null;
    let feedbackTimer; 

    if (myName) {
        loginForm.style.display = 'none';
        mainContent.style.display = 'block'; 
        studentNameDisplay.textContent = myName;
    } else {
        loginForm.style.display = 'block';
        mainContent.style.display = 'none';
    }
    
    joinButton.addEventListener('click', () => {
        const studentName = studentNameInput.value.trim();
        if (studentName) {
            myName = studentName;
            sessionStorage.setItem('studentName', myName);
            loginForm.style.display = 'none';
            mainContent.style.display = 'block'; 
            studentNameDisplay.textContent = myName;

            quizSocket.send(JSON.stringify({
                'type': 'student_join',
                'content': myName
            }));
        } else {
            alert("Please enter your name.");
        }
    });

    function isArabic(text) {
        const arabicRegex = /[\u0600-\u06FF]/;
        return arabicRegex.test(text);
    }

    function sendQuestion() {
        const studentQuestion = studentQuestionInput.value.trim();
        if (studentQuestion) {
            quizSocket.send(JSON.stringify({
                'type': 'student_question',
                'content': {
                    'name': myName,
                    'question': studentQuestion
                }
            }));
            
            displaySentMessage(studentQuestion);
            studentQuestionInput.value = '';
        } else {
            alert("Please enter a question.");
        }
    }

    // Function to display the teacher's broadcast message (FIXED: message persists)
    function displayTeacherMessage(message) {
        teacherMessageText.textContent = message;
        teacherMessageDisplay.style.display = 'block';
        
        // Adjust text direction based on content
        if (isArabic(message)) {
            teacherMessageText.style.direction = 'rtl';
            teacherMessageText.style.textAlign = 'right';
        } else {
            teacherMessageText.style.direction = 'ltr';
            teacherMessageText.style.textAlign = 'left';
        }

        // The message will now stay visible until a new message is received.
    }

    function displaySentMessage(message) {
        messagesContainer.innerHTML = '';
        
        const messageItem = document.createElement('div');
        messageItem.className = 'sent-message-item';
        
        if (isArabic(message)) {
            messageItem.classList.add('rtl');
        } else {
            messageItem.classList.add('ltr');
        }

        messageItem.innerHTML = `
            <span class="edit-icon">&#9998;</span>
            <p class="sent-message-text">${message}</p>
        `;

        const editIcon = messageItem.querySelector('.edit-icon');
        editIcon.addEventListener('click', () => {
            studentQuestionInput.value = message;
            studentQuestionInput.focus();
        });

        messagesContainer.appendChild(messageItem);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    sendQuestionButton.addEventListener('click', sendQuestion);

    studentQuestionInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendQuestion();
        }
    });
    
    // Ensures the displayWrapper height matches the reserved space
    function showVideo() {
        clearTimeout(feedbackTimer);
        jitsiWrapper.style.display = 'block';
        questionPanel.style.display = 'none';
        
        // Set displayWrapper height to match the fixed video height
        displayWrapper.style.height = '450px'; 
        
        currentQuestionData = null;
    }
    
    // Sets the displayWrapper height to fit the question panel content
    function showQuestionPanel() {
        jitsiWrapper.style.display = 'none';
        questionPanel.style.display = 'block';
        initialMessage.style.display = 'none';
        
        // Temporarily set height to auto to measure content
        displayWrapper.style.height = 'auto';
        
        // Set displayWrapper height to match the measured height of the questionPanel content
        const contentHeight = questionPanel.scrollHeight;
        
        // Ensure the minimum height is maintained
        if (contentHeight < 450) {
            displayWrapper.style.height = '450px';
        } else {
            displayWrapper.style.height = contentHeight + 'px';
        }
    }

    // Function to start or resume the timer using the global timeLeft
    function startTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        timerDisplay.textContent = `${timeLeft}s`;
        
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = `${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                timerMessage.textContent = "ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™. ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÖÿπÿ±Ÿàÿ∂ÿ© ŸÑŸÖÿØÿ© ŸÇÿµŸäÿ±ÿ©.";

                if (currentQuestionData) {
                    const correctAnswer = currentQuestionData.correct_answer;
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.dataset.optionValue.trim() === correctAnswer.trim()) {
                            btn.classList.add('correct');
                        }
                    });
                }
                
                feedbackTimer = setTimeout(showVideo, 5000); 
            }
        }, 1000);
    }

    quizSocket.onopen = function() {
        console.log('Student socket opened');
        if (myName) {
            quizSocket.send(JSON.stringify({
                'type': 'student_join',
                'content': myName
            }));
        }
    };

    quizSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Received message:", data);

        if (data.type === 'new_question' || data.type === 'question') {
            
            // Populate content FIRST
            currentQuestionData = data.content;
            clearInterval(timerInterval);
            timerMessage.textContent = "";
            timeLeft = currentQuestionData.time_limit; // Reset timeLeft for new question
            questionContent.innerHTML = '';
            optionsContainer.innerHTML = '';
            
            const questionText = document.createElement('p');
            questionText.textContent = currentQuestionData.question_text;
            questionText.classList.add('question-text');
            questionContent.appendChild(questionText);

            if (currentQuestionData.image_url) {
                const img = document.createElement('img');
                img.src = currentQuestionData.image_url;
                img.alt = "Question Image";
                img.className = "question-image";
                img.onerror = function() {
                    console.error("Failed to load image at:", this.src);
                    this.alt = "Image not found.";
                    this.outerHTML = "<p>Image not found.</p>";
                };
                questionContent.appendChild(img);
            }
            
            currentQuestionData.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.dataset.optionValue = option;
                button.textContent = option;
                button.addEventListener('click', function() {
                    const selectedOption = this.dataset.optionValue;
                    const correctAnswer = currentQuestionData.correct_answer;

                    quizSocket.send(JSON.stringify({
                        'type': 'student_answer',
                        'content': selectedOption
                    }));
                    
                    document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                    clearInterval(timerInterval);
                    timerMessage.textContent = "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ. ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÖÿπÿ±Ÿàÿ∂ÿ© ŸÑŸÖÿØÿ© ŸÇÿµŸäÿ±ÿ©.";

                    if (selectedOption.trim() === correctAnswer.trim()) {
                        this.classList.add('correct');
                    } else {
                        this.classList.add('incorrect');
                    }

                    document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.dataset.optionValue.trim() === correctAnswer.trim()) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    feedbackTimer = setTimeout(showVideo, 5000); 
                });
                optionsContainer.appendChild(button);
            });
            
            // SHOW THE PANEL and adjust height AFTER content is loaded
            showQuestionPanel(); 
            clearTimeout(feedbackTimer); 
            startTimer(); // Start the timer from the new question's limit
            MathJax.typeset(); 

        } else if (data.type === 'update_score') {
            // ... (Score update logic)
        } else if (data.type === 'timer_pause') {
            // ‚≠ê FIX: Stop the student's local timer
            clearInterval(timerInterval);
            timeLeft = data.content; // Update remaining time
            timerDisplay.textContent = `${timeLeft}s (ŸÖŸèÿ™ŸàŸÇŸÅ)`; // Inform student
            timerMessage.textContent = "ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸàŸÇÿ™ ŸÖÿ§ŸÇÿ™ÿßŸã ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÖÿπŸÑŸÖ.";

        } else if (data.type === 'timer_resume') {
            // ‚≠ê FIX: Restart the student's local timer from the current timeLeft
            if (currentQuestionData) { 
                startTimer();
                timerMessage.textContent = "";
            }
        } else if (data.type === 'quiz_end') {
            showQuestionPanel(); 
            questionContent.innerHTML = `<p style="font-size: 20px; color: #10b981;">ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±. ÿ¥ŸÉÿ±ÿß ŸÑŸÖÿ¥ÿßÿ±ŸÉÿ™ŸÉ!</p>`;
            optionsContainer.innerHTML = '';
            clearInterval(timerInterval);
            timerDisplay.textContent = "";
            timerMessage.textContent = "";
            
            // Re-adjust height for the final message, ensuring minimum 450px
            const contentHeight = questionPanel.scrollHeight;
            if (contentHeight < 450) {
                 displayWrapper.style.height = '450px';
            } else {
                 displayWrapper.style.height = contentHeight + 'px';
            }
            
            feedbackTimer = setTimeout(showVideo, 5000); 
            
        } else if (data.type === 'teacher_message_broadcast') { 
            displayTeacherMessage(data.content);
        } else if (data.type === 'kick_user') {
            // ... (Kick user logic)
        }
        MathJax.typeset();
    };

    quizSocket.onclose = function() {
        console.error('Student socket closed unexpectedly');
    };



    const domain = "8x8.vc";
    const options = {
        roomName: "vpaas-magic-cookie-a3caf903c024408ea903326f82630226/ifounderphysics",
        parentNode: document.querySelector("#jitsi-container"),
        configOverwrite: {
            startWithVideoMuted: true,
            disableVideo: true,
            disableInviteFunctions: true,
            disableDeepLinking: true,
            disableShowroomMode: true,
            disableChat: true,
            disableShareFile: true,
            disableSpeakerStats: true,
            disableTileView: true,
            participantsPane: { enabled: false },
            toolbarButtons: ["microphone", "raisehand", "fullscreen", "hangup"]
        },
        interfaceConfigOverwrite: {
            SHOW_JITSI_WATERMARK: false,
            SHOW_WATERMARK_FOR_GUESTS: false,
            SHOW_BRAND_WATERMARK: false,
            SHOW_POWERED_BY: false,
            SHOW_PROMOTIONAL_CLOSE_PAGE: false,
            DISABLE_REMOTE_VIDEO_THUMBNAILS: true,
            TILE_VIEW_ENABLED: false,
            FILM_STRIP_ONLY: false,
            DISABLE_FOCUS_INDICATOR: true
        }
    };


    const api = new JitsiMeetExternalAPI(domain, options);
    
    // Initial display state: Video is visible, Question Panel is hidden
    showVideo(); 
</script>

</body>
{% endblock %}